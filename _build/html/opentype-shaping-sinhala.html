
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Sinhala shaping in OpenType &#8212; OpenType Shaping Documents  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="sinhala-shaping-in-opentype">
<h1>Sinhala shaping in OpenType<a class="headerlink" href="#sinhala-shaping-in-opentype" title="Permalink to this heading">¶</a></h1>
<p>This document details the shaping procedure needed to display text
runs in the Sinhala script.</p>
<p><strong>Table of Contents</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#general-information"><span class="std std-doc">General information</span></a></p></li>
<li><p><a class="reference internal" href="#terminology"><span class="std std-doc">Terminology</span></a></p></li>
<li><p><a class="reference internal" href="#glyph-classification"><span class="std std-doc">Glyph classification</span></a></p>
<ul>
<li><p><a class="reference internal" href="#shaping-classes-and-subclasses"><span class="std std-doc">Shaping classes and subclasses</span></a></p></li>
<li><p><a class="reference internal" href="#sinhala-character-tables"><span class="std std-doc">Sinhala character tables</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-sinh-shaping-model"><span class="std std-doc">The <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code> shaping model</span></a></p>
<ul>
<li><p><a class="reference internal" href="#identifying-syllables-and-other-sequences"><span class="std std-doc">1: Identifying syllables and other sequences</span></a></p></li>
<li><p><a class="reference internal" href="#initial-reordering"><span class="std std-doc">2: Initial reordering</span></a></p></li>
<li><p><a class="reference internal" href="#applying-the-basic-substitution-features-from-gsub"><span class="std std-doc">3: Applying the basic substitution features from GSUB</span></a></p></li>
<li><p><a class="reference internal" href="#final-reordering"><span class="std std-doc">4: Final reordering</span></a></p></li>
<li><p><a class="reference internal" href="#applying-all-remaining-substitution-features-from-gsub"><span class="std std-doc">5: Applying all remaining substitution features from GSUB</span></a></p></li>
<li><p><a class="reference internal" href="#applying-remaining-positioning-features-from-gpos"><span class="std std-doc">6: Applying remaining positioning features from GPOS</span></a></p></li>
</ul>
</li>
</ul>
<section id="general-information">
<h2>General information<a class="headerlink" href="#general-information" title="Permalink to this heading">¶</a></h2>
<p>The Sinhala script belongs to the Indic family, and follows
the same general patterns as the other Indic scripts. More
specifically, it belongs to the South Indic subgroup.</p>
<p>The Sinhala script is used to write multiple languages, most commonly
Sinhalese and Pali. In addition, Sanskrit may be written
in Sinhala, so Sinhala script runs may include glyphs from the Vedic
Extensions block of Unicode.</p>
<p>Unlike many other Indic scripts, there is only one extant Sinhala
script tag defined in OpenType, <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code>.</p>
</section>
<section id="terminology">
<h2>Terminology<a class="headerlink" href="#terminology" title="Permalink to this heading">¶</a></h2>
<p>OpenType shaping uses a standard set of terms for Indic scripts.  The
terms used colloquially in any particular language may vary, however,
potentially causing confusion.</p>
<p><strong>Halant</strong> and <strong>Virama</strong> are both standard terms for the below-base “vowel-killer”
sign. Unicode documents use the term “virama” most frequently, while
OpenType documents use the term “halant” most frequently. In the
Sinhalese language, this sign is known as the <em>al-lakuna</em> or <em>hal kirīma</em>.</p>
<p><strong>Chandrabindu</strong> (or simply <strong>Bindu</strong>) is the standard term for the diacritical mark
indicating that the preceding vowel should be nasalized.</p>
<p>The term <strong>base consonant</strong> is also critical to Indic shaping. The
base consonant of a syllable is the consonant that carries the
syllable’s vowel sound, either the inherent vowel (for an unmarked
base consonant) or a dependent vowel (with the addition of a matra).</p>
<p>A syllable’s base consonant is generally rendered in its full form
(although it may form ligatures), while other consonants in the
syllable frequently take on secondary forms. Different GSUB
substitutions may apply to a script’s <strong>pre-base</strong> and <strong>post-base</strong>
consonants. Some of these substitutions create <strong>above-base</strong> or
<strong>below-base</strong> forms. The <strong>Reph</strong> form of the consonant “Ra” is an
example. In the Sinhalese language, the Reph form is known as <em>repaya</em>.</p>
<p>Syllables may also begin with an <strong>independent vowel</strong> instead of a
consonant. In these syllables, the independent vowel is rendered in
full-letter form, not as a matra, and the independent vowel serves as the
syllable base, similar to a base consonant.</p>
<p>Where possible, using the standard terminology is preferred, as the
use of a language-specific term necessitates choosing one language
over all of the others that share a common script.</p>
</section>
<section id="glyph-classification">
<h2>Glyph classification<a class="headerlink" href="#glyph-classification" title="Permalink to this heading">¶</a></h2>
<p>Shaping Sinhala text depends on the shaping engine correctly
classifying each glyph in the run. As with most other scripts, the
classifications must distinguish between consonants, vowels
(independent and dependent), numerals, punctuation, and various types
of diacritical mark.</p>
<p>For most codepoints, the <code class="docutils literal notranslate"><span class="pre">General</span> <span class="pre">Category</span></code> property defined in the Unicode
standard is correct, but it is not sufficient to fully capture the
expected shaping behavior (such as glyph reordering). Therefore,
Sinhala glyphs must additionally be classified by how they are treated
when shaping a run of text.</p>
<section id="shaping-classes-and-subclasses">
<h3>Shaping classes and subclasses<a class="headerlink" href="#shaping-classes-and-subclasses" title="Permalink to this heading">¶</a></h3>
<p>The shaping classes listed in the tables that follow are defined so
that they capture the positioning rules used by Indic scripts.</p>
<p>For most codepoints, the <em>Shaping class</em> is synonymous with the <code class="docutils literal notranslate"><span class="pre">Indic</span> <span class="pre">Syllabic</span> <span class="pre">Category</span></code> defined in Unicode. However, there are some
distinctions, where the defined category does not fully capture the
behavior of the character in the shaping process.</p>
<p>Several of the diacritic and syllable-modifying marks behave according
to their own rules and, thus, have a special class. These include
<code class="docutils literal notranslate"><span class="pre">BINDU</span></code>, <code class="docutils literal notranslate"><span class="pre">VISARGA</span></code>, <code class="docutils literal notranslate"><span class="pre">AVAGRAHA</span></code>, <code class="docutils literal notranslate"><span class="pre">NUKTA</span></code>, and <code class="docutils literal notranslate"><span class="pre">VIRAMA</span></code>. Some
less-common marks behave according to rules that are similar to these
common marks, and are therefore classified with the corresponding
common mark. The Vedic Extensions also include a <code class="docutils literal notranslate"><span class="pre">CANTILLATION</span></code>
class for tone marks.</p>
<p>Letters generally fall into the classes <code class="docutils literal notranslate"><span class="pre">CONSONANT</span></code>,
<code class="docutils literal notranslate"><span class="pre">VOWEL_INDEPENDENT</span></code>, and <code class="docutils literal notranslate"><span class="pre">VOWEL_DEPENDENT</span></code>. These classes help the
shaping engine parse and identify key positions in a syllable. For
example, Unicode categorizes dependent vowels as <code class="docutils literal notranslate"><span class="pre">Mark</span> <span class="pre">[Mn]</span></code>, but the
shaping engine must be able to distinguish between dependent vowels
and diacritical marks (which are categorized as <code class="docutils literal notranslate"><span class="pre">Mark</span> <span class="pre">[Mn]</span></code>).</p>
<p>Other characters, such as symbols and miscellaneous letters (for
example, letter-like symbols that only occur as standalone entities
and do not occur within syllables), need no special attention from the
shaping engine, so they are not assigned a shaping class.</p>
<p>Numbers are classified as <code class="docutils literal notranslate"><span class="pre">NUMBER</span></code>, even though they evoke no special
behavior from the Indic shaping rules, because there are OpenType features that
might affect how the respective glyphs are drawn, such as <code class="docutils literal notranslate"><span class="pre">tnum</span></code>,
which specifies the usage of tabular-width numerals, and <code class="docutils literal notranslate"><span class="pre">sups</span></code>, which
replaces the default glyphs with superscript variants.</p>
<p>Marks and dependent vowels are further labeled with a mark-placement
subclass, which indicates where the glyph will be placed with respect
to the base character to which it is attached. The actual position of
the glyphs is determined by the lookups found in the font’s GPOS
table, however, the shaping rules for Indic scripts require that the
shaping engine be able to identify marks by their general
position.</p>
<p>For example, left-side dependent vowels (matras), classified
with <code class="docutils literal notranslate"><span class="pre">LEFT_POSITION</span></code>, must frequently be reordered, with the final
position determined by whether or not other letters in the syllable
have formed ligatures or combined into conjunct forms. Therefore, the
<code class="docutils literal notranslate"><span class="pre">LEFT_POSITION</span></code> subclass of the character must be tracked throughout
the shaping process.</p>
<p>There are four basic <em>mark-placement subclasses</em> for dependent vowels
(matras). Each corresponds to the visual position of the matra with
respect to the syllable base to which it is attached:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LEFT_POSITION</span></code> matras are positioned to the left of the syllable base.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RIGHT_POSITION</span></code> matras are positioned to the right of the syllable base.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TOP_POSITION</span></code> matras are positioned above the syllable base.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BOTTOM_POSITION</span></code> matras are positioned below syllable base.</p></li>
</ul>
<p>These positions may also be referred to elsewhere in shaping documents as:</p>
<ul class="simple">
<li><p><em>Pre-base</em> matras</p></li>
<li><p><em>Post-base</em> matras</p></li>
<li><p><em>Above-base</em> matras</p></li>
<li><p><em>Below-base</em> matras</p></li>
</ul>
<p>respectively. The <code class="docutils literal notranslate"><span class="pre">LEFT</span></code>, <code class="docutils literal notranslate"><span class="pre">RIGHT</span></code>, <code class="docutils literal notranslate"><span class="pre">TOP</span></code>, and <code class="docutils literal notranslate"><span class="pre">BOTTOM</span></code> designations
corresponds to Unicode’s preferred terminology. The <em>Pre</em>, <em>Post</em>,
<em>Above</em>, and <em>Below</em> terminology is used in the official descriptions
of OpenType GSUB and GPOS features. Shaping engines may, internally,
use whichever terminology is preferred.</p>
<p>In addition, dependent-vowel codepoints that are composed of multiple
components will be designated in character tables as having a compound
<em>mark-placement subclass</em>, such as <code class="docutils literal notranslate"><span class="pre">TOP_AND_RIGHT</span></code> or <code class="docutils literal notranslate"><span class="pre">LEFT_AND_RIGHT</span></code>.</p>
<p>However, these multi-part matras are decomposed into separate matra
components during the shaping process. After the decomposition, each
matra component will belong to exactly one of the four basic
<em>mark-placement subclasses</em>.</p>
<p>For most mark and dependent-vowel codepoints, the <em>mark-placement
subclass</em> is synonymous with the <code class="docutils literal notranslate"><span class="pre">Indic</span> <span class="pre">Positional</span> <span class="pre">Category</span></code> defined
in Unicode. However, there are some distinctions, where the defined
category does not fully capture the behavior of the character in the
shaping process.</p>
</section>
<section id="sinhala-character-tables">
<h3>Sinhala character tables<a class="headerlink" href="#sinhala-character-tables" title="Permalink to this heading">¶</a></h3>
<p>Separate character tables are provided for the Sinhala, Sinhala
Archaic Numbers, and Vedic Extensions block as well as for other
miscellaneous characters that are used in <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code> text runs:</p>
<ul class="simple">
<li><p><a class="reference internal" href="character-tables/character-tables-sinhala.html#sinhala-character-table"><span class="std std-doc">Sinhala character table</span></a></p></li>
<li><p><a class="reference internal" href="character-tables/character-tables-sinhala.html#sinhala-archaic-numbers-character-table"><span class="std std-doc">Sinhala Archaic Numbers character table</span></a></p></li>
<li><p><a class="reference internal" href="character-tables/character-tables-sinhala.html#vedic-extensions-character-table"><span class="std std-doc">Vedic Extensions character table</span></a></p></li>
<li><p><a class="reference internal" href="character-tables/character-tables-sinhala.html#miscellaneous-character-table"><span class="std std-doc">Miscellaneous character table</span></a></p></li>
</ul>
<p>The tables list each codepoint along with its Unicode general
category, its shaping class, and its mark-placement subclass. The
codepoint’s Unicode name and an example glyph are also provided.</p>
<p>For example:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-left"><p>Codepoint</p></th>
<th class="head text-left"><p>Unicode category</p></th>
<th class="head text-left"><p>Shaping class</p></th>
<th class="head text-left"><p>Mark-placement subclass</p></th>
<th class="head text-left"><p>Glyph</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">U+0D82</span></code></p></td>
<td class="text-left"><p>Mark [Mn]</p></td>
<td class="text-left"><p>BINDU</p></td>
<td class="text-left"><p>RIGHT_POSITION</p></td>
<td class="text-left"><p>ං Anusvara</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p></p></td>
<td class="text-left"><p></p></td>
<td class="text-left"><p></p></td>
<td class="text-left"><p></p></td>
<td class="text-left"><p></p></td>
</tr>
<tr class="row-even"><td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">U+0D9A</span></code></p></td>
<td class="text-left"><p>Letter</p></td>
<td class="text-left"><p>CONSONANT</p></td>
<td class="text-left"><p><em>null</em></p></td>
<td class="text-left"><p>ක Ka</p></td>
</tr>
</tbody>
</table>
<p>Codepoints with no assigned meaning are designated as <em>unassigned</em> in
the <em>Unicode category</em> column.</p>
<p>Assigned codepoints with a <em>null</em> in the <em>Shaping class</em>
column evoke no special behavior from the shaping engine.</p>
<p>The <em>Mark-placement subclass</em> column indicates mark-placement
positioning for codepoints in the <em>Mark</em> category. Assigned, non-mark
codepoints have a <em>null</em> in this column and evoke no special
mark-placement behavior. Marks tagged with [Mn] in the <em>Unicode
category</em> column are categorized as non-spacing; marks tagged with
[Mc] are categorized as spacing-combining.</p>
<p>Some codepoints in the tables use a <em>Shaping class</em> that
differs from the codepoint’s Unicode <em>General Category</em>. The <em>Shaping
class</em> takes precedence during OpenType shaping, as it captures more
specific, script-aware behavior.</p>
<section id="special-function-codepoints">
<h4>Special-function codepoints<a class="headerlink" href="#special-function-codepoints" title="Permalink to this heading">¶</a></h4>
<p>Other important characters that may be encountered when shaping runs
of Sinhala text include the dotted-circle placeholder (<code class="docutils literal notranslate"><span class="pre">U+25CC</span></code>), the
zero-width joiner (<code class="docutils literal notranslate"><span class="pre">U+200D</span></code>) and zero-width non-joiner (<code class="docutils literal notranslate"><span class="pre">U+200C</span></code>), and
the no-break space (<code class="docutils literal notranslate"><span class="pre">U+00A0</span></code>).</p>
<p>Each of these is of particular importance to shaping engines, because
these codepoints interact with the shaping engine, the text run, and
the active font, either to mediate non-default shaping behavior or to
relay information about the current shaping process.</p>
<p>The dotted-circle placeholder is frequently used when displaying a
dependent vowel (matra) or a combining mark in isolation. Real-world
text syllables may also use other characters, such as hyphens or dashes,
in a similar placeholder fashion; shaping engines should cope with
this situation gracefully.</p>
<p>Dotted-circle placeholder characters (like any Unicode codepoint) can
appear anywhere in text input sequences and should be rendered
normally. GPOS positioning lookups should attach mark glyphs to dotted
circles as they would to other non-mark characters. As visible glyphs,
dotted circles can also be involved in GSUB substitutions.</p>
<p>In addition to the default input-text handling process, shaping
engines may also insert dotted-circle placeholders into the text
sequence. Dotted-circle insertions are required when a non-spacing
mark or dependent sign is formed with no base character present.</p>
<p>This requirement covers:</p>
<ul class="simple">
<li><p>Dependent signs that are assigned their own individual Unicode
codepoints (such as most dependent-vowel marks or matras)</p></li>
<li><p>Dependent signs that are formed only by specific sequences of
other codepoints (such as “Reph”)</p></li>
</ul>
<p>In other Indic scripts, the zero-width joiner (ZWJ) is used to prevent
the formation of conjuncts and to suppress the formation of “Reph”.</p>
<p>Sinhala, however, differs considerably in its use of “ZWJ”.</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code> text, “Reph” is only formed by the use of an explicit
“Ra,Halant,ZWJ” sequence.</p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code> text, the sequence
“Consonant_1,Halant,ZWJ,Consonant_2” is used to specify the
subjoined form of “Consonant_2”.</p></li>
</ul>
<p><img alt="" src="sinhala-reph.png" /></p>
<p>The zero-width non-joiner (ZWNJ) is not used in shaping runs of
Sinhala text. The ZWNJ is referenced below in various regular
expressions and shaping rules, however, because it is used by other
Indic scripts.</p>
<p>The ZWJ and ZWNJ characters are, by definition, non-printing control
characters and have the <em>Default_Ignorable</em> property in the Unicode
Character Database. In standard text-display scenarios, their function
is to signal a request from the user to the shaping engine for some
particular non-default behavior. As such, they are not rendered
visually.</p>
<blockquote>
<div><p>Note: Naturally, there are special circumstances where a user or
document might need to request that a ZWJ or ZWNJ be rendered
visually, such as when illustrating the OpenType shaping process, or
displaying Unicode tables.</p>
</div></blockquote>
<p>Because the ZWJ and ZWNJ are non-printing control characters, they can
be ignored by any portion of a software text-handling stack not
involved in the shaping operations that the ZWJ and ZWNJ are designed
to interface with. For example, spell-checking or collation functions
will typically ignore ZWJ and ZWNJ.</p>
<p>Similarly, the ZWJ and ZWNJ should be ignored by the shaping engine
when matching sequences of codepoints against the backtrack and
lookahead sequences of a font’s GSUB or GPOS lookups.</p>
<p>For example:</p>
<ul class="simple">
<li><p>A lookup that substitutes an alternate version of a
dependent-vowel (matra) glyph when it is preceded by “Ka,Halant,Tta”
should still be applied if the dependent-vowel codepoint is preceded
by “Ka,Halant,ZWJ,Tta” in the text run.</p></li>
</ul>
<p>The no-break space (NBSP) is primarily used to display those
codepoints that are defined as non-spacing (marks, dependent vowels
(matras), below-base consonant forms, and post-base consonant forms)
in an isolated context, as an alternative to displaying them
superimposed on the dotted-circle placeholder. These sequences will
match “NBSP,ZWJ,Halant,<em>Consonant</em>”, “NBSP,<em>mark</em>”, or “NBSP,<em>matra</em>”.</p>
</section>
</section>
</section>
<section id="the-sinh-shaping-model">
<h2>The <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code> shaping model<a class="headerlink" href="#the-sinh-shaping-model" title="Permalink to this heading">¶</a></h2>
<p>Processing a run of <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code> text involves six top-level stages:</p>
<ol class="arabic simple">
<li><p>Identifying syllables and other sequences</p></li>
<li><p>Initial reordering</p></li>
<li><p>Applying the basic substitution features from GSUB</p></li>
<li><p>Final reordering</p></li>
<li><p>Applying all remaining substitution features from GSUB</p></li>
<li><p>Applying all remaining positioning features from GPOS</p></li>
</ol>
<p>As with other Indic scripts, the initial reordering stage and the
final reordering stage each involve applying a set of several
script-specific rules. The basic substitution features must be applied
to the run in a specific order. The remaining substitution features in
stage five, however, do not have a mandatory order.</p>
<p>Indic scripts follow many of the same shaping patterns, but they
differ in a few critical characteristics that the shaping engine must
track. These include:</p>
<ul class="simple">
<li><p>The position of the base consonant in a syllable.</p></li>
<li><p>The final position of “Reph”.</p></li>
<li><p>Whether “Reph” must be requested explicitly or if it is formed by
a specific, implicit sequence.</p></li>
<li><p>Whether the below-base forms feature is applied only to consonants
before the syllable base, only to consonants after the base
consonant, or to both.</p></li>
<li><p>The ordering positions for dependent vowels
(matras). Specifically, right-side, above-base, and below-base
matras follow different rules in different scripts.
All Indic scripts position left-side matras in the same
manner, in the ordering position <code class="docutils literal notranslate"><span class="pre">POS_PREBASE_MATRA</span></code>.</p></li>
</ul>
<p>With regard to these common variations, Sinhala’s specific shaping
characteristics include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BASE_POS_LAST_SINHALA</span></code> = The base consonant of a syllable is the last
consonant, not counting any special final-consonant
forms. However, the algorithm used for locating the base
consonant in <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code> text differs from that used by other
<code class="docutils literal notranslate"><span class="pre">BASE_POS_LAST</span></code> scripts.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">REPH_POS_AFTER_POST</span></code> = “Reph” is ordered after the last post-base
consonant form.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">REPH_MODE_EXPLICIT</span></code> = “Reph” is formed by an initial “Ra,Halant,ZWJ” sequence.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BLWF_MODE_PRE_AND_POST</span></code> = The below-forms feature is applied both to
pre-base consonants and to post-base consonants.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MATRA_POS_TOP</span></code> = <code class="docutils literal notranslate"><span class="pre">POS_AFTER_SUBJOINED</span></code> = Above-base matras are
ordered after subjoined (i.e., below-base) consonant forms.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MATRA_POS_RIGHT</span></code> = <code class="docutils literal notranslate"><span class="pre">POS_AFTER_SUBJOINED</span></code> = Right-side matras are
ordered after subjoined (i.e., below-base) consonant forms.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MATRA_POS_BOTTOM</span></code> = <code class="docutils literal notranslate"><span class="pre">POS_AFTER_SUBJOINED</span></code> = Below-base matras are
ordered after all subjoined (i.e., below-base) consonant forms.</p></li>
</ul>
<p>These characteristics determine how the shaping engine must reorder
certain glyphs, how base consonants are determined, and how “Reph”
should be encoded within a run of text.</p>
<section id="identifying-syllables-and-other-sequences">
<h3>1: Identifying syllables and other sequences<a class="headerlink" href="#identifying-syllables-and-other-sequences" title="Permalink to this heading">¶</a></h3>
<p>A syllable in Sinhala consists of a valid orthographic sequence
that may be followed by a “tail” of modifier signs.</p>
<blockquote>
<div><p>Note: The Sinhala Unicode block enumerates two modifier signs,
“Anusvara” (<code class="docutils literal notranslate"><span class="pre">U+0D82</span></code>) and “Visarga” (<code class="docutils literal notranslate"><span class="pre">U+0D83</span></code>). In addition,
Sanskrit text written in Sinhala may include additional signs from
Vedic Extensions block.</p>
</div></blockquote>
<p>Each syllable contains exactly one vowel sound. Valid syllables may
begin with either a consonant or an independent vowel.</p>
<p>If the syllable begins with a consonant, then the consonant that
provides the vowel sound is referred to as the “base” consonant. If
the syllable begins with an independent vowel, that independent vowel
is the syllable’s only vowel sound and serves as the “base”.</p>
<blockquote>
<div><p>Note: A consonant that is not accompanied by a dependent vowel (matra) sign
carries the script’s inherent vowel sound. This vowel sound is changed
by a dependent vowel (matra) sign following the consonant.</p>
</div></blockquote>
<p>From the shaping engine’s perspective, the main distinction between a
syllable with a base consonant and a syllable with an
independent-vowel base is that a syllable with an independent-vowel
base is less likely to include additional consonants in special forms
and less likely to include dependent vowel signs
(matras). Therefore, in the common case, vowel-based syllables may
involve less reordering, substitution feature applications, and other
processing than consonant-based syllables.</p>
<p>In some languages and orthographies, vowel-based syllables are
not permitted to include additional consonants or matras, and certain
GSUB substitution features do not occur. However, there are often
known exceptions, and real-world text makes no such guarantees.</p>
<blockquote>
<div><p>Note: Shaping engines may choose to treat independent-vowel bases
like base consonants for the sake of simplicity or code
reuse.</p>
<p>However, implementations that take this approach should note
that removing the distinction between base consonants and
independent-vowel bases entirely may have unintended
consequences. Making guarantees about the correctness of the results
or about language-specific tests is out of scope for this document.</p>
</div></blockquote>
<p>Generally speaking, the base consonant is the final consonant of the
syllable that does not take on a subjoined form, and its vowel sound
designates the end of the syllable. This rule is synonymous with the
<code class="docutils literal notranslate"><span class="pre">BASE_POS_LAST_SINHALA</span></code> characteristic mentioned earlier.</p>
<p>Valid consonant-based syllables may include one or more additional
consonants that precede the base consonant. Each of these
other, pre-base consonants will be followed by the “Halant” mark, which
indicates that they carry no vowel. They affect pronunciation by
combining with the base consonant (e.g., “<em>str</em>”, “<em>pl</em>”) but they
do not add a vowel sound.</p>
<p>As with other Indic scripts, the consonant “Ra” receives special
treatment; in many circumstances it is replaced by a combining
mark-like form.</p>
<ul class="simple">
<li><p>A “Ra,Halant,ZWJ” sequence at the beginning of a syllable
is replaced with an above-base mark called “Reph”.
This rule is synonymous with the <code class="docutils literal notranslate"><span class="pre">REPH_MODE_EXPLICIT</span></code>
characteristic mentioned earlier.</p></li>
</ul>
<p>In addition, the subjoined form of a post-base-consonant “Ra” can be
explicitly requested with a “Halant,ZWJ,Ra” sequence. This form is called
“Rakaaraansaya”.</p>
<p>“Reph” characters must be reordered after the syllable-identification
stage is complete. “Rakaaraansaya” is not reordered.</p>
<p>In addition to valid syllables, standalone sequences may occur, such
as when an isolated codepoint is shown in example text.</p>
<blockquote>
<div><p>Note: Foreign loanwords, when written in the Sinhala script, may
not adhere to the syllable-formation rules described above. In
particular, it is not uncommon to encounter foreign loanwords that
contain a word-final suffix of consonants.</p>
<p>Nevertheless, such word-final suffixes will be correctly matched by
the regular expressions listed below. These loanwords are pronounced
different, which raises issues for potential readers, but the
character sequences do not affect the shaping process.</p>
</div></blockquote>
<p>Syllables should be identified by examining the run and matching
glyphs, based on their categorization, using regular expressions.</p>
<p>The following general-purpose Indic-shaping regular expressions can be
used to match Sinhala syllables.</p>
<p>The regular expressions utilize the shaping classes from the tables
above. For the purpose of syllable identification, more general
classes can be used, as defined in the following table. This
simplifies the resulting expressions.</p>
<div class="highlight-markdown notranslate"><div class="highlight"><pre><span></span><span class="ge">_ra_</span>		= The consonant &quot;Ra&quot; 
<span class="ge">_consonant_</span>	= ( <span class="sb">`CONSONANT`</span> | <span class="sb">`CONSONANT_DEAD`</span> ) - <span class="ge">_ra_</span>
<span class="ge">_vowel_</span>		= <span class="sb">`VOWEL_INDEPENDENT`</span>
<span class="ge">_nukta_</span>	  	= <span class="sb">`NUKTA`</span>
<span class="ge">_halant_</span>	= <span class="sb">`VIRAMA`</span>
<span class="ge">_zwj_</span>		= <span class="sb">`JOINER`</span>
<span class="ge">_zwnj_</span>		= <span class="sb">`NON_JOINER`</span>
<span class="ge">_matra_</span>		= <span class="sb">`VOWEL_DEPENDENT`</span> | <span class="sb">`PURE_KILLER`</span>
<span class="ge">_syllablemodifier_</span>	= <span class="sb">`SYLLABLE_MODIFIER`</span> | <span class="sb">`BINDU`</span> | <span class="sb">`VISARGA`</span> | <span class="sb">`GEMINATION_MARK`</span>
<span class="ge">_vedicsign_</span>	= <span class="sb">`CANTILLATION`</span>
<span class="ge">_placeholder_</span>	= <span class="sb">`PLACEHOLDER`</span> | <span class="sb">`CONSONANT_PLACEHOLDER`</span> | <span class="sb">`NUMBER`</span> 
<span class="ge">_dottedcircle_</span>	= <span class="sb">`DOTTED_CIRCLE`</span>
<span class="ge">_repha_</span>		= <span class="sb">`CONSONANT_PRE_REPHA`</span>
<span class="ge">_consonantmedial_</span>	= <span class="sb">`CONSONANT_MEDIAL`</span>
<span class="ge">_symbol_</span>	= <span class="sb">`SYMBOL`</span> | <span class="sb">`AVAGRAHA`</span>
<span class="ge">_consonantwithstacker_</span>	= <span class="sb">`CONSONANT_WITH_STACKER`</span>
<span class="ge">_other_</span>		= <span class="sb">`OTHER`</span>| <span class="sb">`MODIFYING_LETTER`</span>
</pre></div>
</div>
<blockquote>
<div><p>Note: the <em>ra</em> identification class is mutually exclusive with
the <em>consonant</em> class. The union of the <em>consonant</em> and <em>ra</em> classes
is used in the regular expression elements below in order to
correctly identify “Ra” characters that do not trigger “Reph” or
“Rakaar” shaping behavior.</p>
<p>Note, also, that the cantillation mark “combining Ra” in the
Devanagari Extended block does <em>not</em> belong to the <em>ra</em>
identification class, and that the other “combining consonant”
cantillation marks in the Devanagari Extended block do not belong to
the <em>consonant</em> identification class.</p>
</div></blockquote>
<blockquote>
<div><p>Note: The <em>placeholder</em> identification class includes codepoints
that are often used in place of vowels or consonants when a document
needs to display a matra, mark, or special form in isolation or
in another context beyond a standard syllable. Examples of
<em>placeholder</em> codepoints include hyphens and non-breaking
spaces. Sequences that utilize this approach should be identified as
“standalone” syllables.</p>
<p>The <em>placeholder</em> identification class also includes numerals, which
are commonly used as word substitutes within normal text. Examples
include ordinals (e.g., “4th”).</p>
</div></blockquote>
<blockquote>
<div><p>Note: The <em>other</em> identification class includes codepoints that
do not interact with adjacent characters for shaping purposes. Even
though some of these codepoints (such as <code class="docutils literal notranslate"><span class="pre">MODIFYING_LETTER</span></code>) can
occur within words, they evoke no behavior from the shaping
engine and do not factor into the regular expressions that
follow. Therefore, the shaping engine may choose to ignore them
during syllable identification; they are listed here for completeness.</p>
</div></blockquote>
<p>These identification classes form the bases of the following regular
expression elements:</p>
<div class="highlight-markdown notranslate"><div class="highlight"><pre><span></span>C	= <span class="ge">_consonant_</span> | <span class="ge">_ra_</span>
Z	= <span class="ge">_zwj_</span> | <span class="ge">_zwnj_</span>
REPH	= (<span class="ge">_ra_</span> <span class="ge">_halant_</span>) | <span class="ge">_repha_</span>
CN		= C <span class="ge">_zwj_</span>? <span class="ge">_nukta_</span>?
FORCED_RAKAR	= <span class="ge">_zwj_</span> <span class="ge">_halant_</span> <span class="ge">_zwj_</span> <span class="ge">_ra_</span>
S	= <span class="ge">_symbol_</span> <span class="ge">_nukta_</span>?
MATRA_GROUP	= Z{0,3} <span class="ge">_matra_</span> <span class="ge">_nukta_</span>? (<span class="ge">_halant_</span> | FORCED_RAKAR)?
SYLLABLE_TAIL	= (Z? <span class="ge">_syllablemodifier_</span> <span class="ge">_syllablemodifier_</span>? <span class="ge">_zwnj_</span>?)? <span class="ge">_vedicsign_</span>{0,3}
HALANT_GROUP	= Z? <span class="ge">_halant_</span> (<span class="ge">_zwj_</span> <span class="ge">_nukta_</span>?)?
FINAL_HALANT_GROUP	= HALANT_GROUP | (<span class="ge">_halant_</span> <span class="ge">_zwnj_</span>)
MEDIAL_GROUP	= <span class="ge">_consonantmedial_</span>?
HALANT_OR_MATRA_GROUP	= FINAL_HALANT_GROUP | MATRA_GROUP*)
</pre></div>
</div>
<blockquote>
<div><p>Note: Practically speaking, shaping engines are highly unlikely to
encounter more than 4 sequential <code class="docutils literal notranslate"><span class="pre">(MATRA_GROUP)</span></code>
instances in any real-word syllables. Thus, implementations may
choose to limit occurrences by limiting the above expressions to a
finite length, such as <code class="docutils literal notranslate"><span class="pre">(MATRA_GROUP){0,4}</span></code> .</p>
</div></blockquote>
<p>Using the above elements, the following regular expressions define the
possible syllable types:</p>
<p>A consonant-based syllable will match the expression:</p>
<div class="highlight-markdown notranslate"><div class="highlight"><pre><span></span>(<span class="ge">_repha_</span>|<span class="ge">_consonantwithstacker_</span>)? (CN HALANT_GROUP)* CN MEDIAL_GROUP HALANT_OR_MATRA_GROUP SYLLABLE_TAIL
</pre></div>
</div>
<blockquote>
<div><p>Note: Practically speaking, shaping engines are highly unlikely to
encounter more than 4 sequential <code class="docutils literal notranslate"><span class="pre">(CN</span> <span class="pre">HALANT_GROUP)</span></code>
instances in any real-word syllables. Thus, implementations may
choose to limit occurrences by limiting the above expressions to a
finite length, such as <code class="docutils literal notranslate"><span class="pre">(CN</span> <span class="pre">HALANT_GROUP){0,4}</span></code> .</p>
</div></blockquote>
<p>A vowel-based syllable will match the expression:</p>
<div class="highlight-markdown notranslate"><div class="highlight"><pre><span></span>REPH? <span class="ge">_vowel_</span> <span class="ge">_nukta_</span>? (<span class="ge">_zwj_</span> | (HALANT_GROUP CN)* MEDIAL_GROUP HALANT_OR_MATRA_GROUP SYLLABLE_TAIL)
</pre></div>
</div>
<blockquote>
<div><p>Note: Practically speaking, shaping engines are highly unlikely to
encounter more than 4 sequential <code class="docutils literal notranslate"><span class="pre">(HALANT_GROUP</span> <span class="pre">CN)</span></code>
instances in any real-word syllables. Thus, implementations may
choose to limit occurrences by limiting the above expressions to a
finite length, such as <code class="docutils literal notranslate"><span class="pre">(HALANT_GROUP</span> <span class="pre">CN){0,4}</span></code> .</p>
</div></blockquote>
<p>A standalone syllable will match the expression:</p>
<div class="highlight-markdown notranslate"><div class="highlight"><pre><span></span>((_repha_|_consonantwithstacker_)? <span class="ge">_placeholder_</span> | REPH? <span class="ge">_dottedcircle_</span>) <span class="ge">_nukta_</span>? (HALANT_GROUP CN)* MEDIAL_GROUP HALANT_OR_MATRA_GROUP SYLLABLE_TAIL
</pre></div>
</div>
<blockquote>
<div><p>Note: Practically speaking, shaping engines are highly unlikely to
encounter more than 4 sequential <code class="docutils literal notranslate"><span class="pre">(HALANT_GROUP</span> <span class="pre">CN)</span></code>
instances in any real-word syllables. Thus, implementations may
choose to limit occurrences by limiting the above expressions to a
finite length, such as <code class="docutils literal notranslate"><span class="pre">(HALANT_GROUP</span> <span class="pre">CN){0,4}</span></code> .</p>
</div></blockquote>
<blockquote>
<div><p>Note: Although they are labeled as “standalone syllables” here,
many sequences that match the standalone regular expression above
are instances where a document needs to display a matra, combining
mark, or special form in isolation. Such sequences might not have
any significance with regard to the definition of syllables used in
the language or orthography of the text.</p>
</div></blockquote>
<p>A symbol-based syllable will match the expression:</p>
<div class="highlight-markdown notranslate"><div class="highlight"><pre><span></span>S SYLLABLE_TAIL
</pre></div>
</div>
<p>A broken syllable will match the expression:</p>
<div class="highlight-markdown notranslate"><div class="highlight"><pre><span></span>REPH? <span class="ge">_nukta_</span>? (HALANT_GROUP CN)* MEDIAL_GROUP HALANT_OR_MATRA_GROUP SYLLABLE_TAIL
</pre></div>
</div>
<blockquote>
<div><p>Note: Practically speaking, shaping engines are highly unlikely to
encounter more than 4 sequential <code class="docutils literal notranslate"><span class="pre">(HALANT_GROUP</span> <span class="pre">CN)</span></code>
instances in any real-word syllables. Thus, implementations may
choose to limit occurrences by limiting the above expressions to a
finite length, such as <code class="docutils literal notranslate"><span class="pre">(HALANT_GROUP</span> <span class="pre">CN){0,4}</span></code> .</p>
</div></blockquote>
<p>The primary problem involved in shaping broken syllables is the lack
of a syllable base (either a base consonant or an independent
vowel). Without a syllable base, the shaping engine cannot perform
GPOS positioning and other contextual operations that are required
later in the shaping process.</p>
<p>To make up for this limitation, shaping engines should insert a
dotted-circle placeholder (<code class="docutils literal notranslate"><span class="pre">U+25CC</span></code>) character into the text stream
where the missing syllable base was expected to occur. This
placeholder allows the shaping process to proceed on a best-effort
basis at handling the broken-syllable sequence, but making guarantees
about the orthographic correctness or preferred appearance of the
final result is out of scope for this document.</p>
<p>Shaping engines can perform this dotted-circle insertion at any point
after the broken syllable has been recognized and before GSUB features
are applied. However, the best results will likely be attained by
performing the insertion immediately, before proceeding to
stage 2. This will enable the maximum number of GSUB and GPOS features
in the active font to be correctly applied to the text run by ensuring
that all reordering, tagging, and sorting algorithms are executed as
usual.</p>
<blockquote>
<div><p>Note: In software stacks where other text-handling operations, such
as Unicode normalization and localization, are performed before the
text run is passed to the shaping engine, there is a potential for
the dotted-circle insertion to cause unexpected effects.</p>
<p>For example, if a <code class="docutils literal notranslate"><span class="pre">ccmp</span></code> or <code class="docutils literal notranslate"><span class="pre">locl</span></code> feature substitutes the default
dotted-circle placeholder glyph with a variant glyph of a different
size or weight for the (<code class="docutils literal notranslate"><span class="pre">U+25CC</span></code>) codepoint, then any shaping engine
which relies on another software component to handle that
functionality must take additional care to ensure consistency.</p>
</div></blockquote>
<p>The expressions above use state-machine syntax from the Ragel
state-machine compiler. The operators represent:</p>
<div class="highlight-markdown notranslate"><div class="highlight"><pre><span></span>a* = zero or more copies of a
b+ = one or more copies of b
c? = optional instance of c
d{n} = exactly n copies of d
d{,n} = zero to n copies of d
d{n,} = n or more copies of d
d{n,m} = n to m copies of d
!e = not e
^f = character-level not f
g.h = concatenation of g and h
i|j = i or j
( ) = grouping of expression elements
</pre></div>
</div>
<p>After the syllables have been identified, each of the subsequent
shaping stages occurs on a per-syllable basis.</p>
</section>
<section id="initial-reordering">
<h3>2: Initial reordering<a class="headerlink" href="#initial-reordering" title="Permalink to this heading">¶</a></h3>
<p>The initial reordering stage is used to relocate glyphs from the
phonetic order in which they occur in a run of text to the
orthographic order in which they are presented visually.</p>
<blockquote>
<div><p>Note: Primarily, this means moving dependent-vowel (matra) glyphs,
“Ra,Halant,ZWJ” glyph sequences, and other consonants that take special
treatment in some circumstances. “Ya” may take on special forms,
depending on its position in the syllable.</p>
<p>These reordering moves are mandatory. The final-reordering stage
may make additional moves, depending on the text and on the features
implemented in the active font.</p>
</div></blockquote>
<p>The syllable should be processed by tagging each glyph with its
intended position based on its ordering category. After all glyphs
have been tagged, the entire syllable should be sorted in stable order,
so that glyphs of the same ordering category remain in the same
relative position with respect to each other.</p>
<p>The final sort order of the ordering categories should be:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>POS_RA_TO_BECOME_REPH
POS_PREBASE_MATRA
POS_PREBASE_CONSONANT

POS_SYLLABLE_BASE
POS_AFTER_MAIN

POS_ABOVEBASE_CONSONANT

POS_BEFORE_SUBJOINED
POS_BELOWBASE_CONSONANT
POS_AFTER_SUBJOINED

POS_BEFORE_POST
POS_POSTBASE_CONSONANT
POS_AFTER_POST

POS_FINAL_CONSONANT
POS_SMVD
</pre></div>
</div>
<p>This sort order enumerates all of the possible final positions to
which a codepoint might be reordered, across all of the Indic
scripts. It includes some ordering categories not utilized in
Sinhala.</p>
<p>The basic positions (left to right) are “Reph”
(<code class="docutils literal notranslate"><span class="pre">POS_RA_TO_BECOME_REPH</span></code>), dependent vowels (matras) and consonants
positioned before the base consonant or syllable base
(<code class="docutils literal notranslate"><span class="pre">POS_PREBASE_MATRA</span></code> and <code class="docutils literal notranslate"><span class="pre">POS_PREBASE_CONSONANT</span></code>), the base consonant
or syllable base (<code class="docutils literal notranslate"><span class="pre">POS_SYLLABLE_BASE</span></code>), above-base consonants
(<code class="docutils literal notranslate"><span class="pre">POS_ABOVEBASE_CONSONANT</span></code>), below-base consonants
(<code class="docutils literal notranslate"><span class="pre">POS_BELOWBASE_CONSONANT</span></code>), consonants positioned after the base
consonant or syllable base (<code class="docutils literal notranslate"><span class="pre">POS_POSTBASE_CONSONANT</span></code>), syllable-final
consonants (<code class="docutils literal notranslate"><span class="pre">POS_FINAL_CONSONANT</span></code>), and syllable-modifying or Vedic
signs (<code class="docutils literal notranslate"><span class="pre">POS_SMVD</span></code>).</p>
<p>In addition, several secondary positions are defined to handle various
reordering rules that deal with relative, rather than absolute,
positioning. <code class="docutils literal notranslate"><span class="pre">POS_AFTER_MAIN</span></code> means that a character must be
positioned immediately after the syllable base. <code class="docutils literal notranslate"><span class="pre">POS_BEFORE_SUBJOINED</span></code>
and <code class="docutils literal notranslate"><span class="pre">POS_AFTER_SUBJOINED</span></code> mean that a character must be positioned
before or after any below-base consonants, respectively. Similarly,
<code class="docutils literal notranslate"><span class="pre">POS_BEFORE_POST</span></code> and <code class="docutils literal notranslate"><span class="pre">POS_AFTER_POST</span></code> mean that a character must be
positioned before or after any post-base consonants, respectively.</p>
<p>For shaping-engine implementers, the names used for the ordering
categories matter only in that they are unambiguous.</p>
<p>For a definition of the “base” consonant, refer to step 2.1, which
follows.</p>
<section id="base-consonant">
<h4>2.1: Base consonant<a class="headerlink" href="#base-consonant" title="Permalink to this heading">¶</a></h4>
<p>The first step is to determine the base consonant of the syllable, if
there is one, and tag it as <code class="docutils literal notranslate"><span class="pre">POS_SYLLABLE_BASE</span></code>.</p>
<p>In a syllable that begins with an independent vowel, the independent
vowel will always serve as the syllable base, and it should be tagged
as <code class="docutils literal notranslate"><span class="pre">POS_SYLLABLE_BASE</span></code>. The shaping engine can then proceed to step 2.</p>
<p>In a standalone sequence or other syllable that begins with a placeholder
or dotted circle, the placeholder or dotted circle will always serve
as the syllable base, and it should be tagged as
<code class="docutils literal notranslate"><span class="pre">POS_SYLLABLE_BASE</span></code>. The shaping engine can then proceed to step 2.</p>
<p>In a syllable that begins with a consonant, the shaping engine must
determine the base consonant by a script-specific algorithm.</p>
<blockquote>
<div><p>Note: Shaping engines may choose to treat independent-vowel bases
like base consonants for the sake of simplicity or code
reuse.</p>
<p>However, implementations that take this approach should note
that removing the distinction between base consonants and
independent-vowel bases entirely may have unintended
consequences. Making guarantees about the correctness of the results
or about language-specific tests is out of scope for this document.</p>
</div></blockquote>
<p>The base consonant is defined as the consonant in a consonant-based
syllable that carries the syllable’s vowel sound. That vowel sound
will either be provided by the script’s inherent vowel (in which case
it is not written with a separate character) or the sound will be designated
by the addition of a dependent-vowel (matra) sign.</p>
<p>Due to the different usage of ZWJ characters in <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code> text runs, a
different algorithm is required for the shaper to identify the base
consonant of a syllable. The algorithm for determining the base
consonant in Sinhala is</p>
<ul class="simple">
<li><p>If the syllable starts with “Ra,Halant,ZWJ”, exclude the starting
“Ra” from the list of consonants to be considered.</p></li>
<li><p>Starting from the end of the syllable, move backwards until a consonant is found.</p>
<ul>
<li><p>If the consonant is immediately preceded by a ZWJ, move to the
previous consonant. If the consonant is not immediately
preceded by a ZWJ, stop.</p></li>
<li><p>If the consonant is the first consonant, stop.</p></li>
</ul>
</li>
<li><p>The consonant stopped at will be the base consonant.</p></li>
</ul>
<blockquote>
<div><p>Note: Unlike with many other Indic scripts, it is not necessary for
the shaping engine to independently determine if any consonant has a
post-base or below-base form in the active font. The use of a ZWJ
character before a consonant in the search explicitly designates
such a special form.</p>
</div></blockquote>
</section>
<section id="matra-decomposition">
<h4>2.2: Matra decomposition<a class="headerlink" href="#matra-decomposition" title="Permalink to this heading">¶</a></h4>
<p>Second, any multi-part dependent vowels (matras) must be decomposed
into their individual components.</p>
<p>Sinhala has four multi-part dependent vowels, “Ee” (<code class="docutils literal notranslate"><span class="pre">U+0DDA</span></code>), “O”
(<code class="docutils literal notranslate"><span class="pre">U+0DDC</span></code>), “Oo” (<code class="docutils literal notranslate"><span class="pre">U+0DDD</span></code>), and “Au” (<code class="docutils literal notranslate"><span class="pre">U+0DDE</span></code>). Each
has a canonical decomposition, so this step is unambiguous.</p>
<blockquote>
<div><p>“Ee” (<code class="docutils literal notranslate"><span class="pre">U+0DDA</span></code>) decomposes to “<code class="docutils literal notranslate"><span class="pre">U+0DD9</span></code>,<code class="docutils literal notranslate"><span class="pre">U+0DCA</span></code>”</p>
<p>“O” (<code class="docutils literal notranslate"><span class="pre">U+0DDC</span></code>)  decomposes to “<code class="docutils literal notranslate"><span class="pre">U+0DD9</span></code>,<code class="docutils literal notranslate"><span class="pre">U+0DCF</span></code>”</p>
<p>“Oo” (<code class="docutils literal notranslate"><span class="pre">U+0DDD</span></code>) decomposes to “<code class="docutils literal notranslate"><span class="pre">U+0DD9</span></code>,<code class="docutils literal notranslate"><span class="pre">U+0DCF</span></code>, <code class="docutils literal notranslate"><span class="pre">U+0DCA</span></code>”</p>
<p>“Au” (<code class="docutils literal notranslate"><span class="pre">U+0DDE</span></code>) decomposes to “<code class="docutils literal notranslate"><span class="pre">U+0DD9</span></code>,<code class="docutils literal notranslate"><span class="pre">U+0DDF</span></code>”</p>
</div></blockquote>
<p>Because this decomposition is a character-level operation, the shaping
engine may choose to perform it earlier, such as during an initial
Unicode-normalization stage. However, all such decompositions must be
completed before the shaping engine begins step three, below.</p>
<blockquote>
<div><p>Note: The decomposition of “Oo” (<code class="docutils literal notranslate"><span class="pre">U+0DDD</span></code>) is atypical; Unicode
specifies that the codepoint decomposes to “O” (<code class="docutils literal notranslate"><span class="pre">U+0DDC</span></code>) followed
by <code class="docutils literal notranslate"><span class="pre">U+0DCA</span></code>; the “O” codepoint is then decomposed to
“<code class="docutils literal notranslate"><span class="pre">U+0DD9</span></code>,<code class="docutils literal notranslate"><span class="pre">U+0DCF</span></code>”. Shaping engines must take care not to miss this
second decomposition.</p>
</div></blockquote>
<blockquote>
<div><p>Note: For Sinhala, the <code class="docutils literal notranslate"><span class="pre">pstf</span></code> substitution feature of GSUB is
defined as replacing the entire multi-part matra with its right-side
component.</p>
<p>The Microsoft Uniscribe shaping engine historically
supported this behavior – in a sense, decomposing each matra into
its left-side component followed by a duplicate of the original
matra, then substituting the duplicated matra with the right-side
matra component in <a class="reference internal" href="#pstf"><span class="std std-doc">stage 3, step 10</span></a>, when the <code class="docutils literal notranslate"><span class="pre">pstf</span></code>
feature is applied.</p>
<p>Fonts that were engineered to support this behavior might not
include GPOS positioning rules for the right-side matra components,
relying instead on the <code class="docutils literal notranslate"><span class="pre">pstf</span></code> substitution to provide a suitable
replacement. Shaping engines should do their best to deal gracefully
with fonts that were developed only with this behavior in mind.</p>
</div></blockquote>
<p><img alt="Multi-part matra decomposition" src="_images/sinhala-matra-decompose.png" /></p>
</section>
<section id="tag-matras">
<h4>2.3: Tag matras<a class="headerlink" href="#tag-matras" title="Permalink to this heading">¶</a></h4>
<p>Third, all left-side dependent-vowel (matra) signs must be tagged to be
moved to the beginning of the syllable, with <code class="docutils literal notranslate"><span class="pre">POS_PREBASE_MATRA</span></code>.</p>
<p>Above-base, right-side, and below-base dependent-vowel (matra) signs
must be tagged with <code class="docutils literal notranslate"><span class="pre">POS_AFTER_SUBJOINED</span></code>.</p>
</section>
<section id="adjacent-marks">
<h4>2.4: Adjacent marks<a class="headerlink" href="#adjacent-marks" title="Permalink to this heading">¶</a></h4>
<p>Fourth, any subsequences of marks that include a “Nukta” and a
“Halant” or Vedic sign must be reordered so that the “Nukta” appears
first.</p>
<p>This means that the subsequence “Halant,Nukta” is reordered to
“Nukta,Halant” and that the subsequence “<em>Vedic_sign</em>,Nukta” is
reordered to “Nukta,_Vedic_sign”.</p>
<p>For subsequences of affected marks that are longer than two, the
reordering operation must be repeated until the “Nukta” is the first
character in the subsequence. No other marks in the subsequence
should be reordered.</p>
<p>This order is canonical in Unicode and is required so that
“<em>consonant</em>,Nukta” substitution rules from GSUB will be correctly
matched later in the shaping process.</p>
<blockquote>
<div><p>Note: Nukta usage in Sinhala is rare.</p>
</div></blockquote>
</section>
<section id="pre-base-consonants">
<h4>2.5: Pre-base consonants<a class="headerlink" href="#pre-base-consonants" title="Permalink to this heading">¶</a></h4>
<p>Fifth, consonants that occur before the base consonant or syllable base must be tagged
with <code class="docutils literal notranslate"><span class="pre">POS_PREBASE_CONSONANT</span></code>.</p>
</section>
<section id="reph">
<h4>2.6: Reph<a class="headerlink" href="#reph" title="Permalink to this heading">¶</a></h4>
<p>Sixth, initial “Ra,Halant,ZWJ” sequences that will become “Reph”s must be tagged with
<code class="docutils literal notranslate"><span class="pre">POS_RA_TO_BECOME_REPH</span></code>.</p>
<blockquote>
<div><p>Note: an initial “Ra,Halant,ZWJ” sequence will always become a “Reph”.</p>
</div></blockquote>
</section>
<section id="post-base-consonants">
<h4>2.7: Post-base consonants<a class="headerlink" href="#post-base-consonants" title="Permalink to this heading">¶</a></h4>
<p>Seventh, any non-base consonants that occur after a dependent vowel
(matra) sign must be tagged with <code class="docutils literal notranslate"><span class="pre">POS_POSTBASE_CONSONANT</span></code>.</p>
<p>In Sinhala, the only consonants that can appear in this position are
“Ra” and “Ya”. A “Halant,ZWJ,Ya” sequence after the base consonant or syllable base will take on
the “Yansaya” form when the <code class="docutils literal notranslate"><span class="pre">vatu</span></code> feature is applied. A
“Halant,ZWJ,Ra” sequence after the base consonant or syllable base will take on
the “Rakaaraansaya” form when the <code class="docutils literal notranslate"><span class="pre">vatu</span></code> feature is applied.</p>
<p><img alt="Yansaya ligation" src="_images/sinhala-vatu-va.png" /></p>
<p><img alt="Rakaaraansaya ligation" src="_images/sinhala-vatu-ra.png" /></p>
</section>
<section id="mark-tagging">
<h4>2.8: Mark tagging<a class="headerlink" href="#mark-tagging" title="Permalink to this heading">¶</a></h4>
<p>Eighth, all marks must be tagged.</p>
<blockquote>
<div><p>Note: In this step, joiner and non-joiner characters must also be
tagged according to the same rules given for marks, even though
these characters are not categorized as marks in Unicode.</p>
</div></blockquote>
<p>Marks in the <code class="docutils literal notranslate"><span class="pre">BINDU</span></code>, <code class="docutils literal notranslate"><span class="pre">VISARGA</span></code>, <code class="docutils literal notranslate"><span class="pre">AVAGRAHA</span></code>, <code class="docutils literal notranslate"><span class="pre">CANTILLATION</span></code>,
<code class="docutils literal notranslate"><span class="pre">SYLLABLE_MODIFIER</span></code>, <code class="docutils literal notranslate"><span class="pre">GEMINATION_MARK</span></code>, and <code class="docutils literal notranslate"><span class="pre">SYMBOL</span></code> categories should
be tagged with <code class="docutils literal notranslate"><span class="pre">POS_SMVD</span></code>.</p>
<p>All “Nukta”s must be tagged with the same positioning tag as the
preceding consonant, independent vowel, placeholder, or dotted circle.</p>
<p>All remaining marks (not in the <code class="docutils literal notranslate"><span class="pre">POS_SMVD</span></code> category and not “Nukta”s)
must be tagged with the same positioning tag as the closest non-mark
character the mark has affinity with, so that they move together
during the sorting step.</p>
<p>There are two possible cases: those marks before the syllable base
and those marks after the syllable base. In addition, an exception is
made for “Halant” marks that follow a left-side (pre-base) matra.</p>
<ol class="arabic">
<li><p>Initially, all remaining marks should be tagged with the same
positioning tag as the closest preceding consonant.</p></li>
<li><p>For each consonant after the syllable base (such as post-base
consonants, below-base consonants, or final consonants), all
remaining marks located between that current consonant and any
previous consonant should be tagged with the same positioning tag as
the current (later) consonant.</p>
<p>In other words, all consonants preceding the syllable base “own” the
marks that follow them, while all consonants after the syllable base
“own” the marks that come before them. When a syllable does not have
any consonants after the syllable base, the syllable base should
“own” all the marks that follow it.</p>
</li>
<li><p>Finally, “Halant” marks that follow a left-side dependent vowel
(matra) should <em>not</em> be tagged with the left-side matra’s
positioning tag. Instead, the “Halant” should be tagged with the
positioning tag of the non-mark character preceding the left-side
matra. This prevents the “Halant” mark from being moved with the
left-side matra when the syllable is sorted.</p></li>
</ol>
<!--- HarfBuzz also tags everything between a post-base consonant or -->
<!--matra and another post-base consonant as belonging to the latter -->
<!--post-base consonant. --->
</section>
<section id="sort-syllable">
<h4>2.9: Sort syllable<a class="headerlink" href="#sort-syllable" title="Permalink to this heading">¶</a></h4>
<p>With these steps completed, the syllable can be sorted into the final
sort order as listed at the beginning of stage 2.</p>
<p>The glyphs in the syllable should be sorted in stable order,
so that glyphs of the same ordering category remain in the same
relative position with respect to each other.</p>
</section>
<section id="flag-sequences-for-possible-feature-applications">
<h4>2.10: Flag sequences for possible feature applications<a class="headerlink" href="#flag-sequences-for-possible-feature-applications" title="Permalink to this heading">¶</a></h4>
<p>With the initial reordering complete, those glyphs in the syllable that
may have GSUB or GPOS features applied in stages 3, 5, and 6 should be
flagged for each potential feature.</p>
<p>This flagging is preliminary; the set of potential features varies
between different scripts and which features are supported varies
between fonts. It is also possible that the application of
one feature on a glyph sequence will perform a substitution that makes
a later feature no longer applicable to the updated sequence.</p>
<p>Consequently, the flagging must be completed before shaping proceeds
to the stages during which features are applied.</p>
<p>Some shaping features, such as <code class="docutils literal notranslate"><span class="pre">locl</span></code>, can potentially apply to any
glyphs. Therefore it is not necessary to maintain a separate flag for
these features in the bitmask (or other data structure) used to track
the flags – although shaping engines may do so if desired.</p>
<p>The sequences to flag are summarized in the list below; a full
description of each feature’s function and interpretation is provided
in GSUB and GPOS application stages that follow.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">akhn</span></code> should match “<em>Consonant</em>,Halant,ZWJ,<em>Consonant</em>” and
“<em>Consonant</em>,ZWJ,Halant,<em>Consonant</em>” sequences</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rphf</span></code> should match initial “Ra,Halant,ZWJ” sequences</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pstf</span></code> should match “<em>Matra</em>” in post-base position</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vatu</span></code> should match “Halant,ZWJ,Ra” and “Halant,ZWJ,Va”</p></li>
</ul>
</section>
</section>
<section id="applying-the-basic-substitution-features-from-gsub">
<h3>3: Applying the basic substitution features from GSUB<a class="headerlink" href="#applying-the-basic-substitution-features-from-gsub" title="Permalink to this heading">¶</a></h3>
<p>The basic-substitution stage applies mandatory substitution features
using the rules in the font’s GSUB table. In preparation for this
stage, glyph sequences should be flagged for possible application
of GSUB features in stage 2, step 10.</p>
<p>The order in which these substitutions must be performed is fixed for
all Indic scripts:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>locl
nukt (not used in Sinhala)
akhn
rphf 
rkrf (not used in Sinhala)
pref (not used in Sinhala)
blwf (not used in Sinhala)
abvf (not used in Sinhala)
half (not used in Sinhala)
pstf
vatu
cjct (not used in Sinhala)
cfar (not used in Sinhala)
</pre></div>
</div>
<section id="locl">
<h4>3.1 locl<a class="headerlink" href="#locl" title="Permalink to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">locl</span></code> feature replaces default glyphs with any language-specific
variants, based on examining the language setting of the text run.</p>
<blockquote>
<div><p>Note: Strictly speaking, the use of localized-form substitutions is
not part of the shaping process, but of the localization process,
and could take place at an earlier point while handling the text
run. However, shaping engines are expected to complete the
application of the <code class="docutils literal notranslate"><span class="pre">locl</span></code> feature before applying the subsequent
GSUB substitutions in the following steps.</p>
</div></blockquote>
</section>
<section id="nukt">
<h4>3.2: nukt<a class="headerlink" href="#nukt" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><p>This feature is not used in Sinhala.</p>
</div></blockquote>
</section>
<section id="akhn">
<h4>3.3: akhn<a class="headerlink" href="#akhn" title="Permalink to this heading">¶</a></h4>
<p>In Sinhala, the <code class="docutils literal notranslate"><span class="pre">akhn</span></code> feature provides two substitution types.</p>
<ul class="simple">
<li><p>“Consonant,Halant,ZWJ,Consonant” sequences are used to specify a ligature.</p></li>
<li><p>“Consonant,ZWJ,Halant,Consonant” sequences are used to specify
“touching consonant” substitutions used in Pali and Sanskrit.</p></li>
</ul>
<p><img alt="Ligature substitution" src="_images/sinhala-akhn-ligature.png" /></p>
<p><img alt="Touching consonant substitution" src="_images/sinhala-akhn-touching.png" /></p>
</section>
<section id="rphf">
<h4>3.4: rphf<a class="headerlink" href="#rphf" title="Permalink to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">rphf</span></code> feature replaces initial “Ra,Halant,ZWJ” sequences with the
“Reph” glyph.</p>
<p><img alt="Reph composition" src="_images/sinhala-rphf.png" /></p>
</section>
<section id="rkrf">
<h4>3.5 rkrf<a class="headerlink" href="#rkrf" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><p>This feature is not used in Sinhala.</p>
</div></blockquote>
</section>
<section id="pref">
<h4>3.6 pref<a class="headerlink" href="#pref" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><p>This feature is not used in Sinhala.</p>
</div></blockquote>
</section>
<section id="blwf">
<h4>3.7: blwf<a class="headerlink" href="#blwf" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><p>This feature is not used in Sinhala.</p>
</div></blockquote>
</section>
<section id="abvf">
<h4>3.8: abvf<a class="headerlink" href="#abvf" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><p>This feature is not used in Sinhala.</p>
</div></blockquote>
</section>
<section id="half">
<h4>3.9: half<a class="headerlink" href="#half" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><p>This feature is not used in Sinhala.</p>
</div></blockquote>
</section>
<section id="pstf">
<h4>3.10: pstf<a class="headerlink" href="#pstf" title="Permalink to this heading">¶</a></h4>
<p>In Sinhala, the <code class="docutils literal notranslate"><span class="pre">pstf</span></code> feature replaces multi-part dependent vowels
(matras) with the right-side matra component of the canonical
decomposition.</p>
<blockquote>
<div><p>Note: This substitution is possible because all multi-part dependent
vowels in Sinhala use the same left-side matra component, <code class="docutils literal notranslate"><span class="pre">U+0DD9</span></code>.</p>
<p>The Microsoft Uniscribe shaping engine historically
supported this behavior by handling the decomposition of multi-part
dependent vowels in <a class="reference internal" href="#matra-decomposition"><span class="std std-doc">stage 2, step 2</span></a>
differently for Sinhala – in a sense, decomposing each matra into
its left-side component followed by a duplicate of the original
matra, then substituting the duplicated matra with the right-side
matra component when the <code class="docutils literal notranslate"><span class="pre">pstf</span></code> feature is applied.</p>
<p>Shaping engines may, optionally, decompose multi-part dependent
vowels in <a class="reference internal" href="#matra-decomposition"><span class="std std-doc">stage 2, step 2</span></a> into their
canonical Unicode decompositions, as is done in other scripts, and
substitute the decomposed right-side matra components at that point.</p>
<p>Doing so will negate the need to apply the <code class="docutils literal notranslate"><span class="pre">pstf</span></code> substitution.
However, fonts that were engineered to support the
Uniscribe-supported behavior might not include GPOS positioning
rules for the right-side matra components, relying instead on the
<code class="docutils literal notranslate"><span class="pre">pstf</span></code> substitution to provide a suitable replacement. Shaping
engines should do their best to deal gracefully with fonts that were
developed only with this behavior in mind.</p>
</div></blockquote>
<p><img alt="Post-base form substitution" src="_images/sinhala-pstf.png" /></p>
</section>
<section id="vatu">
<h4>3.11: vatu<a class="headerlink" href="#vatu" title="Permalink to this heading">¶</a></h4>
<p>In Sinhala, the <code class="docutils literal notranslate"><span class="pre">vatu</span></code> feature replaces certain sequences with
ligatures using the subjoined forms of “Ra” or “Ya”.</p>
<ul class="simple">
<li><p>The sequence “Consonant,Halant,ZWJ,Ra” triggers the
“Rakaaraansaya” form of the consonant.</p></li>
<li><p>The sequence “Consonant,Halant,ZWJ,Ya” triggers the “Yansaya” form
of the consonant.</p></li>
</ul>
<p><img alt="Rakaaraansaya ligation" src="_images/sinhala-vatu-ra.png" /></p>
<p><img alt="Yansaya ligation" src="_images/sinhala-vatu-va.png" /></p>
</section>
<section id="cjct">
<h4>3.12: cjct<a class="headerlink" href="#cjct" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><p>This feature is not used in Sinhala.</p>
</div></blockquote>
</section>
<section id="cfar">
<h4>3.13: cfar<a class="headerlink" href="#cfar" title="Permalink to this heading">¶</a></h4>
<blockquote>
<div><p>This feature is not used in Sinhala.</p>
</div></blockquote>
</section>
</section>
<section id="final-reordering">
<h3>4: Final reordering<a class="headerlink" href="#final-reordering" title="Permalink to this heading">¶</a></h3>
<p>The final reordering stage repositions marks, dependent-vowel (matra)
signs, and “Reph” glyphs to the appropriate location with respect to
the base consonant or syllable base. Because multiple substitutions
may have occurred during the application of the basic-shaping features
in the preceding stage, these repositioning moves could not be
performed during the initial reordering stage.</p>
<p>Like the initial reordering stage, the steps involved in this stage
occur on a per-syllable basis.</p>
<section id="id1">
<h4>4.1: Base consonant<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h4>
<p>The final reordering stage, like the initial reordering stage, begins
with determining the syllable base of each syllable, following the
same algorithm used in stage 2, step 1.</p>
<p>In a syllable that begins with an independent vowel, the independent
vowel will always serve as the syllable base. In a standalone sequence or
other syllable that begins with a placeholder or a dotted circle, the
placeholder or dotted circle will always serve as the syllable base.</p>
<p>In a syllable that begins with a consonant, the shaping engine must
repeat the base-consonant search algorithm used in stage 2, step 1.</p>
<p>The codepoint of the underlying base consonant or syllable base will
not change between the search performed in stage 2, step 1, and the
search repeated here. However, the application of GSUB shaping
features in stage 3 means that several ligation and many-to-one
substitutions may have taken place. The final glyph produced by that
process may, therefore, be a conjunct or ligature form — in most
cases, such a glyph will not have an assigned Unicode codepoint.</p>
</section>
<section id="pre-base-matras">
<h4>4.2: Pre-base matras<a class="headerlink" href="#pre-base-matras" title="Permalink to this heading">¶</a></h4>
<p>Pre-base dependent vowels (matras) that were reordered during the
initial reordering stage must be moved to their final position. This
position is defined as:</p>
<ul class="simple">
<li><p>after the last standalone “Halant” glyph that comes after the
matra’s starting position and also comes before the main
consonant.</p></li>
<li><p>If a zero-width joiner follows this last standalone “Halant”, the
final matra position is moved to after the joiner.</p></li>
</ul>
<p>This means that the matra will move to the right of all explicit
“consonant,Halant” subsequences, but will stop to the left of the base
consonant or syllable base, all conjuncts or ligatures that contain
the base consonant or syllable base, and all half forms.</p>
<p><img alt="Pre-base matra positioning" src="_images/sinhala-matra-position.png" /></p>
<blockquote>
<div><p>Note: OpenType and Unicode both state that if the syllable includes
a ZWJ immediately after the last “Halant”, then the final matra
position should be after the ZWJ.</p>
<p>However, there are several test sequences indicating that
Microsoft’s Uniscribe shaping engine did not follow this rule (in,
at least, Devanagari and Bengali text), and in these circumstances
Uniscribe instead makes the final matra position before the final
“Consonant,Halant,ZWJ”.</p>
<p>Subsequently, the HarfBuzz shaping engine has also followed the same
pattern. If other shaping engine implementations prefer to maintain
maximum compatibility with Uniscribe and HarfBuzz, then they should
also follow suit.</p>
</div></blockquote>
<blockquote>
<div><p>Note: The Microsoft script-development specifications for OpenType
shaping also state that if a zero-width non-joiner follows the last
standalone “Halant”, the final matra position is moved to after the
non-joiner. However, it is unnecessary to test for this condition,
because a “Halant,ZWNJ” subsequence is, by definition, the end of a
syllable. Consequently, a “Halant,ZWNJ” cannot be followed by a
pre-base dependent vowel.</p>
</div></blockquote>
</section>
<section id="id2">
<h4>4.3: Reph<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h4>
<p>“Reph” must be moved from the beginning of the syllable to its final
position. Because Sinhala incorporates the <code class="docutils literal notranslate"><span class="pre">REPH_POS_AFTER_POST</span></code>
shaping characteristic, this final position is defined to be
immediately after any post-base consonant forms.</p>
<p>The algorithm for finding the final “Reph” position is</p>
<ul>
<li><p>Move the “Reph” to the position immediately before
the first post-base matra, syllable modifier, or Vedic sign that
has a positioning tag after the script’s “Reph” position in the
syllable sort order (as listed in <a class="reference internal" href="#initial-reordering"><span class="std std-doc">stage
2</span></a>). This will be the final “Reph”
position.</p>
<blockquote>
<div><p>Note: Because Sinhala incorporates the
<code class="docutils literal notranslate"><span class="pre">REPH_POS_AFTER_POST</span></code> shaping characteristic, this means
any positioning tag of <code class="docutils literal notranslate"><span class="pre">POS_FINAL_CONSONANT</span></code> or later,
although a post-base matra, syllable modifier, or Vedic sign
would not typically be tagged with <code class="docutils literal notranslate"><span class="pre">POS_FINAL_CONSONANT</span></code>.</p>
</div></blockquote>
</li>
<li><p>If no other location has been located in the previous step, move
the “Reph” to the end of the syllable.</p></li>
</ul>
<p>Finally, if the final position of “Reph” or “Repha” occurs after a
“<em>matra</em>,Halant” subsequence, then “Reph”/”Repha” must be repositioned to the
left of “Halant”, to allow for potential matching with <code class="docutils literal notranslate"><span class="pre">abvs</span></code> or
<code class="docutils literal notranslate"><span class="pre">psts</span></code> substitutions from GSUB.</p>
<p><img alt="Reph positioning" src="_images/sinhala-reph-position.png" /></p>
</section>
<section id="pre-base-reordering-consonants">
<h4>4.4: Pre-base-reordering consonants<a class="headerlink" href="#pre-base-reordering-consonants" title="Permalink to this heading">¶</a></h4>
<p>Any pre-base-reordering consonants must be moved to immediately before
the base consonant or syllable base.</p>
<p>Sinhala does not use pre-base-reordering consonants, so this step will
involve no work when processing <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code> text. It is included here in order
to maintain compatibility with the other Indic scripts.</p>
</section>
<section id="initial-matras">
<h4>4.5: Initial matras<a class="headerlink" href="#initial-matras" title="Permalink to this heading">¶</a></h4>
<p>Any left-side dependent vowels (matras) that are at the start of a
word must be flagged for potential substitution by the <code class="docutils literal notranslate"><span class="pre">init</span></code> feature
of GSUB.</p>
<p>Sinhala does not use the <code class="docutils literal notranslate"><span class="pre">init</span></code> feature, so this step will
involve no work when processing <code class="docutils literal notranslate"><span class="pre">&lt;sinh&gt;</span></code> text. It is included here in
order to maintain compatibility with the other Indic scripts.</p>
</section>
</section>
<section id="applying-all-remaining-substitution-features-from-gsub">
<h3>5: Applying all remaining substitution features from GSUB<a class="headerlink" href="#applying-all-remaining-substitution-features-from-gsub" title="Permalink to this heading">¶</a></h3>
<p>In this stage, the remaining substitution features from the GSUB table
are applied. In preparation for this stage, glyph sequences should be
flagged for possible application of GSUB features in stage 2,
step 10.</p>
<p>The order in which these features are applied is not canonical; they
should be applied in the order in which they appear in the GSUB table
in the font.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>init (not used in Sinhala)
pres
abvs
blws
psts
haln (not used in Sinhala)
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">init</span></code> feature is not used in Sinhala.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pres</span></code> feature replaces pre-base-consonant glyphs with special
presentations forms. This can include ligatures, “touching consonant” forms,
and stylistic variants of left-side dependent vowels (matras).</p>
<p><img alt="Pre-base substitutions" src="_images/sinhala-pres.png" /></p>
<p>The <code class="docutils literal notranslate"><span class="pre">abvs</span></code> feature replaces above-base-consonant glyphs with special
presentation forms. This usually includes contextual variants of
above-base marks or contextually appropriate mark-and-base ligatures.</p>
<p><img alt="Above-base substitutions" src="_images/sinhala-abvs.png" /></p>
<p>The <code class="docutils literal notranslate"><span class="pre">blws</span></code> feature replaces below-base-consonant glyphs with special
presentation forms. This usually includes replacing base consonants or
syllable bases
and attached below-base marks with contextual ligatures.</p>
<p><img alt="Below-base substitutions" src="_images/sinhala-blws.png" /></p>
<p>The <code class="docutils literal notranslate"><span class="pre">psts</span></code> feature replaces post-base-consonant glyphs with special
presentation forms. This usually includes replacing right-side
dependent vowels (matras) with stylistic variants or replacing
base-consonant/matra pairs with contextual ligatures.</p>
<p><img alt="Post-base substitutions" src="_images/sinhala-psts.png" /></p>
<p>The <code class="docutils literal notranslate"><span class="pre">haln</span></code> feature is not used in Sinhala.</p>
<blockquote>
<div><p>Note: The <code class="docutils literal notranslate"><span class="pre">calt</span></code> feature, which allows for generalized application
of contextual alternate substitutions, is usually applied at this
point. However, <code class="docutils literal notranslate"><span class="pre">calt</span></code> is not mandatory for correct Sinhala shaping
and may be disabled in the application by user preference.</p>
</div></blockquote>
</section>
<section id="applying-remaining-positioning-features-from-gpos">
<h3>6: Applying remaining positioning features from GPOS<a class="headerlink" href="#applying-remaining-positioning-features-from-gpos" title="Permalink to this heading">¶</a></h3>
<p>In this stage, mark positioning, kerning, and other GPOS features are
applied.</p>
<p>As with the preceding stage, the order in which these features are
applied is not canonical; they should be applied in the order in which
they appear in the GPOS table in the font.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    dist
    abvm
    blwm
</pre></div>
</div>
<blockquote>
<div><p>Note: The <code class="docutils literal notranslate"><span class="pre">kern</span></code> feature is usually applied at this stage, if it is
present in the font. However, <code class="docutils literal notranslate"><span class="pre">kern</span></code> (like <code class="docutils literal notranslate"><span class="pre">calt</span></code>, above) is not
mandatory for shaping Sinhala text and may be disabled by user preference.</p>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">dist</span></code> feature adjusts the horizontal positioning of
glyphs. Unlike <code class="docutils literal notranslate"><span class="pre">kern</span></code>, adjustments made with <code class="docutils literal notranslate"><span class="pre">dist</span></code> do not require the
application or the user to enable any software <em>kerning</em> features, if
such features are optional.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">abvm</span></code> feature positions above-base marks for attachment to base
characters. In Sinhala, this includes “Reph” in addition to
above-base dependent vowels (matras), diacritical marks, and Vedic signs.</p>
<p><img alt="Above-base mark positioning" src="_images/sinhala-abvm.png" /></p>
<p>The <code class="docutils literal notranslate"><span class="pre">blwm</span></code> feature positions below-base marks for attachment to base
characters. In Sinhala, this includes below-base dependent vowels
(matras) and diacritical marks.</p>
<p><img alt="Below-base mark positioning" src="_images/sinhala-blwm.png" /></p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">OpenType Shaping Documents</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=n8willis&repo=opentype-shaping-documents&type=watch&count=True&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="README.html">Scripts</a></li>
    
    <li class="toctree-l1"><a href="character-tables/character-tables-index.html">Character tables</a></li>
    
    <li class="toctree-l1"><a href="opentype-shaping-normalization.html">Normalization</a></li>
    
    <li class="toctree-l1"><a href="notes/README.html">Notes</a></li>
    
    <li class="toctree-l1"><a href="errata.html">Errata</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Sponsored by YesLogic.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/opentype-shaping-sinhala.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>